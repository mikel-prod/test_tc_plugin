<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello World - Trimble Connect Extension</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 60px 40px;
            text-align: center;
            max-width: 600px;
            width: 100%;
            animation: fadeIn 0.6s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 3.5rem;
            color: #333;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 30px;
        }

        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 20px;
        }

        .info {
            margin-top: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 0.9rem;
            color: #555;
        }

        .info strong {
            color: #333;
        }

        #tc-info {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #1565c0;
            display: none;
        }

        #tc-info.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Project File Statistics ðŸ“Š</h1>
        <p class="subtitle">Files by Extension</p>
        <div class="badge">Trimble Connect Extension v1.0</div>

        <div class="info" id="loading-info">
            <strong>Status:</strong> Loading project files...<br>
            <strong>Date:</strong> <span id="current-date"></span>
        </div>

        <div id="file-stats" style="display: none; margin-top: 30px;">
            <div style="text-align: left; max-height: 400px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #667eea;">
                            <th style="padding: 10px; text-align: left;">Extension</th>
                            <th style="padding: 10px; text-align: right;">Count</th>
                        </tr>
                    </thead>
                    <tbody id="stats-table"></tbody>
                </table>
            </div>
            <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; font-size: 0.9rem;">
                <strong>Total Files:</strong> <span id="total-files">0</span>
            </div>
        </div>

        <div id="error-info" style="display: none; margin-top: 20px; padding: 20px; background: #ffebee; border-radius: 10px; color: #c62828;"></div>
    </div>

    <!-- Load Trimble Connect Workspace API -->
    <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>

    <script>
        // Display current date
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        let globalAPI = null;
        let accessToken = null;

        // Initialize extension
        async function initExtension() {
            try {
                console.log('Connecting to Trimble Connect Workspace API...');
                console.log('TrimbleConnectWorkspace available:', typeof TrimbleConnectWorkspace);

                if (typeof TrimbleConnectWorkspace === 'undefined') {
                    throw new Error('TrimbleConnectWorkspace not loaded');
                }

                // Connect to the API
                const API = await TrimbleConnectWorkspace.connect(
                    window.parent,
                    (event, args) => {
                        console.log('Event received:', event, args);
                        switch (event) {
                            case "extension.command":
                                handleCommand(args.data);
                                break;
                            case "extension.accessToken":
                                console.log('Access token received:', args.data);
                                accessToken = args.data;
                                if (accessToken) {
                                    loadFileStatistics();
                                }
                                break;
                            case "extension.userSettingsChanged":
                                console.log('User settings changed');
                                break;
                            default:
                                console.log('Unknown event:', event);
                        }
                    },
                    30000
                );

                globalAPI = API;
                console.log('Connected to Trimble Connect!');

                // Create and set the menu
                const mainMenuObject = {
                    title: "File Statistics",
                    icon: "https://mikel-prod.github.io/test_tc_plugin/icon.svg",
                    command: "show_file_stats"
                };

                await API.ui.setMenu(mainMenuObject);
                console.log('Menu set successfully!');

                // Request access token permission
                console.log('Requesting access token permission...');
                const token = await API.extension.getPermission("accesstoken");
                console.log('Access token result:', token);

                if (token && token !== 'denied') {
                    accessToken = token;
                    loadFileStatistics();
                }

            } catch (error) {
                console.error('Failed to connect to Trimble Connect:', error);
                showError('Failed to connect: ' + error.message);
            }
        }

        async function loadFileStatistics() {
            try {
                console.log('Loading file statistics...');

                // Get project info
                const project = await globalAPI.project.getProject();
                console.log('Project:', project);

                // Get project files using Core API
                // Map location to API endpoint
                let apiHost = 'app.connect.trimble.com'; // Default US
                if (project.location === 'europe' || project.location === 'eu') {
                    apiHost = 'app21.connect.trimble.com'; // Europe
                } else if (project.location === 'apac' || project.location === 'asia') {
                    apiHost = 'app31.connect.trimble.com'; // Asia Pacific
                }

                const apiUrl = `https://${apiHost}/tc/api/2.0/projects/${project.id}/files`;

                console.log('Fetching files from:', apiUrl);

                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const files = await response.json();
                console.log('Files received:', files);

                // Count files by extension
                const extensionCounts = {};
                let totalFiles = 0;

                function processFiles(fileList) {
                    if (!Array.isArray(fileList)) return;

                    fileList.forEach(file => {
                        if (file.type === 'FILE') {
                            totalFiles++;
                            const ext = file.name.split('.').pop().toLowerCase() || 'no extension';
                            extensionCounts[ext] = (extensionCounts[ext] || 0) + 1;
                        }
                    });
                }

                processFiles(files);

                // Display results
                displayStatistics(extensionCounts, totalFiles);

            } catch (error) {
                console.error('Error loading file statistics:', error);
                showError('Failed to load files: ' + error.message);
            }
        }

        function displayStatistics(extensionCounts, totalFiles) {
            document.getElementById('loading-info').style.display = 'none';
            document.getElementById('file-stats').style.display = 'block';

            const table = document.getElementById('stats-table');
            table.innerHTML = '';

            // Sort by count descending
            const sorted = Object.entries(extensionCounts).sort((a, b) => b[1] - a[1]);

            sorted.forEach(([ext, count]) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #eee';
                row.innerHTML = `
                    <td style="padding: 10px;">.${ext}</td>
                    <td style="padding: 10px; text-align: right; font-weight: 600;">${count}</td>
                `;
                table.appendChild(row);
            });

            document.getElementById('total-files').textContent = totalFiles;
        }

        function showError(message) {
            document.getElementById('loading-info').style.display = 'none';
            const errorDiv = document.getElementById('error-info');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function handleCommand(command) {
            console.log('Command clicked:', command);
            switch (command) {
                case "show_file_stats":
                    console.log('File Statistics menu clicked!');
                    if (accessToken) {
                        loadFileStatistics();
                    }
                    break;
                default:
                    console.log('Unknown command:', command);
            }
        }

        // Start the extension
        initExtension();
    </script>
</body>
</html>
